services:
  # Backend API Server
  app:
    build:
      context: ./Backend
      dockerfile: ${DOCKERFILE:-Dockerfile}
    container_name: soc-ai-agent-backend
    ports:
      - "${HOST_PORT:-8080}:8080"
    volumes:
      # 開発環境のみマウント（.env で ENABLE_HOT_RELOAD=true の場合）
      - ${BACKEND_MOUNT:-/dev/null}:${BACKEND_MOUNT_TARGET:-/dev/null}
    env_file:
      - ${ENV_FILE:-./Backend/.env}
    depends_on:
      db:
        condition: service_started
    networks:
      - soc-ai-network
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILE:-3}"

  # MySQL Database
  db:
    image: mysql:8.0
    container_name: soc-ai-db
    ports:
      - "${DB_HOST_BIND:-127.0.0.1}:3306:3306"
    env_file:
      - ${ENV_FILE:-./Backend/.env}
    volumes:
      - ${DB_VOLUME_TYPE:-mysql_data}:/var/lib/mysql
      - ${MYSQL_CONF_DIR:-./mysql/conf.d}:/etc/mysql/conf.d:ro
    networks:
      - soc-ai-network
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILE:-3}"

# frontend
  frontend: # サービス名を追加
    build:
      context: ./frontend # ./frontend をルートとして使用（従来の構造を維持）
      dockerfile: ${DOCKERFILE:-Dockerfile} # Dockerfile名もデフォルト設定を使用
    container_name: soc-ai-agent-frontend
    restart: 'always'
    # volumes:
    #   - ./frontend:/app  # 本番ビルド時は不要（開発時のみ）
    ports:
      - "3000:3000"
    env_file:
      - ${ENV_FILE:-./Backend/.env}
    depends_on:
      app:
        condition: service_started
    networks:
      - soc-ai-network
volumes:
  mysql_data:
    driver: local

networks:
  soc-ai-network:
    driver: bridge



